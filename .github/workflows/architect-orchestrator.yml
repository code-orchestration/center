name: Architect Orchestrator

on:
  issues:
    types: [opened]

jobs:
  check-service-request:
    if: contains(github.event.issue.labels.*.name, 'service-type')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up environment
        run: |
          echo "Setting up environment variables"
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.issue.body }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Parse issue content
        id: parse
        run: |
          # Extract service details from issue body
          SERVICE_NAME=$(echo "$ISSUE_BODY" | grep -A 1 "Service Name" | tail -1 | xargs)
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          
          # Create a structured prompt for SuperClaude
          cat > /tmp/architect-prompt.txt << 'PROMPT_EOF'
          You are the System Architect persona. Analyze this service request and perform the following tasks:
          
          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
          
          ${{ github.event.issue.body }}
          
          Tasks to complete:
          1. Create appropriate repositories for this service (may be multiple if needed)
          2. Determine the best technology stack (language, framework, database)
          3. Create detailed issues in each repository for implementation
          4. Set up CI/CD pipelines with lint and test configurations
          5. Create a comprehensive architecture document
          
          Use your best judgment for technology choices based on the requirements.
          PROMPT_EOF
          
      - name: Run SuperClaude Architect
        uses: anthropics/claude-code-github-action@main
        with:
          prompt-file: /tmp/architect-prompt.txt
          model: opus
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          working-directory: .
          flags: |
            --persona architect
            --mode system-design
            --ultrathink
            
      - name: Comment on issue with results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const body = `
            ## 🏗️ Architect Analysis Complete
            
            The SuperClaude Architect has analyzed your service request and initiated the creation process.
            
            Check the following for updates:
            - New repositories created in the organization
            - Issues created in each repository
            - CI/CD pipelines configured
            
            The development phase will begin automatically once repositories are set up.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });